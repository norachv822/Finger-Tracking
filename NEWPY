import cv2 #legge i frame video
import mediapipe as mp #mediapipe: modulo per tracciare le mani
from pythonosc.udp_client import SimpleUDPClient #SimpleUDPClient per inviare dati via OSC(Open Sound Control) a Processing

client = SimpleUDPClient("127.0.0.1", 12000) # crea una porta 12000 dove mandare le informazioni a Processing 

# Inizializza il modulo tracciamento mani
mp_hands = mp.solutions.hands #modulo per tracciare le mani
hands = mp_hands.Hands( #crea un oggetto Hands per tracciare le mani
    max_num_hands=1, #traccia una mano
    min_detection_confidence=0.7, #soglia minima per rilevare la mano
    min_tracking_confidence=0.7 #soglia minima per tracciare la mano
)
mp_draw = mp.solutions.drawing_utils #utilit√† per disegnare i punti di riferimento della mano

cap = cv2.VideoCapture(0) #apre la webcam

while True: #ciclo infinito per leggere i frame dalla webcam
    success, img = cap.read() #legge un frame dalla webcam
    if not success: #se non riesce a leggere il frame, esce dal ciclo
        break 

    img = cv2.flip(img, 1) #specchio orizzontale dell'immagine
    rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB) #converte l'immagine da BGR a RGB
    results = hands.process(rgb) #processa l'immagine per rilevare le mani

    if results.multi_hand_landmarks: #se vengono rilevate delle mani
        for handLms in results.multi_hand_landmarks: #per ogni mano rilevata
            pollice_tip = handLms.landmark[4]
            indice_tip = handLms.landmark[8]
            medio_tip = handLms.landmark[12]
            anulare_tip = handLms.landmark[16]
            mignolo_tip = handLms.landmark[20]
            polso = handLms.landmark[0]
            
            client.send_message("/pollice", [pollice_tip.x, pollice_tip.y])
            client.send_message("/indice", [indice_tip.x, indice_tip.y]) #invia la posizione del dito indice a Processing
            client.send_message("/medio", [medio_tip.x, medio_tip.y])
            client.send_message("/anulare", [anulare_tip.x, anulare_tip.y])
            client.send_message("/mignolo", [mignolo_tip.x, mignolo_tip.y]) #invia la posizione del dito medio a Processing
            client.send_message("/polso", [polso.x, polso.y])
            mp_draw.draw_landmarks(img, handLms, mp_hands.HAND_CONNECTIONS) #disegna i punti di riferimento della mano sull'immagine

    cv2.imshow("MediaPipe Finger Tracking", img) #mostra l'immagine con i punti di riferimento della mano
    if cv2.waitKey(1) & 0xFF == 27:  #esce dal ciclo se si preme il tasto 'Esc'
        break

cap.release() #rilascia la webcam
cv2.destroyAllWindows() #chiude tutte le finestre aperte da OpenCV
